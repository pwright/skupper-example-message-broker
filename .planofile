from skewer import *

@command
def generate(app):
    generate_readme("skewer.yaml", "README.md")

@command
def render(app):
    generate(app)
    run(f"pandoc -o README.html README.md")

@command
def test(app):
    generate_readme("skewer.yaml", make_temp_file())
    run_example_steps("skewer.yaml")

@command
def build_images(app):
    run("podman build -t quay.io/skupper/job-processor processor")
    run("podman build -t quay.io/skupper/job-requestor requestor")

@command
def push_images(app):
    run("podman push quay.io/skupper/job-processor")
    run("podman push quay.io/skupper/job-requestor")

@command
def test_services(app):
    connect_file = write(make_temp_file(), '{"scheme": "amqp", "host": "localhost", "port": 45672}')

    with working_env(MESSAGING_CONNECT_FILE=connect_file):
        with start("podman run -it -p 45672:5672 -e AMQ_USER=admin -e AMQ_PASSWORD=admin quay.io/artemiscloud/activemq-artemis-broker") as broker:
            sleep(5)

            with start("python3 processor/main.py"), start("python3 requestor/main.py"):
                sleep(1)

                run("curl -i http://0.0.0.0:8080/submit-job -d text=abc123")

                sleep(2)
