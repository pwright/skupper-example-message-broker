from skewer import *

@command
def generate(app):
    generate_readme("skewer.yaml", "README.md")

@command
def render(app):
    generate(app)
    run(f"pandoc -o README.html README.md")

@command
def test(app):
    generate_readme("skewer.yaml", make_temp_file())
    run_example_steps("skewer.yaml")

@command
def build_images(app):
    run("podman build -t quay.io/skupper/job-processor job-processor")
    run("podman build -t quay.io/skupper/job-requestor job-requestor")

@command
def push_images(app):
    run("podman push quay.io/skupper/job-processor")
    run("podman push quay.io/skupper/job-requestor")

@command
def test_services(app):
    connect_file = write(make_temp_file(), '{"scheme": "amqp", "host": "localhost"}')

    with working_env(MESSAGING_CONNECT_FILE=connect_file):
      with start("podman run -it -p 5672:5672 -e AMQ_USER=admin -e AMQ_PASSWORD=admin quay.io/artemiscloud/activemq-artemis-broker") as broker:
          sleep(5)

          with start("python3 job-processor/main.py"), start("python3 job-requestor/main.py"):
              sleep(1)

              run("curl -X POST -H 'Content-Type: application/json' -d '{\"text\":\"abc123\"}' http://localhost:8080/submit-job")

              sleep(1)

              run("curl http://localhost:8080/get-result")
