from skewer import *

@command
def generate(app):
    import yaml

    with open("skewer.yaml") as skewer_file:
        skewer_data = yaml.safe_load(skewer_file)
        generate_readme(skewer_data)

    print(read("README.md"))

@command
def test(app):
    import yaml

    with open("skewer.yaml") as skewer_file:
        work_dir = make_temp_dir()
        minikube_profile = "skupper-example-message-broker"
        skewer_data = yaml.safe_load(skewer_file)

        with open("/tmp/minikube-tunnel-output", "w") as tunnel_output_file:
            try:
                run(f"minikube start -p {minikube_profile}")
                run(f"minikube profile {minikube_profile}")

                with start("minikube tunnel", output=tunnel_output_file):
                    kubeconfigs = setup_kubeconfigs(work_dir, skewer_data)
                    run_steps(work_dir, skewer_data, kubeconfigs)
            finally:
                run(f"minikube delete -p {minikube_profile}")

def setup_kubeconfigs(work_dir, skewer_data):
    kubeconfigs = dict()

    for name, value in skewer_data["kubeconfigs"].items():
        kubeconfig_file = value["file"].replace("~", work_dir)
        namespace = value["namespace"]

        with working_env(KUBECONFIG=kubeconfig_file):
            run(f"minikube update-context")
            run(f"kubectl create namespace {namespace}")
            run(f"kubectl config set-context --current --namespace {namespace}")

        kubeconfigs[name] = kubeconfig_file

    return kubeconfigs

def run_steps(work_dir, skewer_data, kubeconfigs):
    for step_data in skewer_data["steps"]:
        for session_data in step_data["sessions"]:
            kubeconfig_name = session_data["kubeconfig"]
            kubeconfig_file = kubeconfigs[kubeconfig_name]

            with working_env(KUBECONFIG=kubeconfig_file):
                for command_data in session_data["commands"]:
                    run(command_data["run"].replace("~", work_dir), shell=True)

                    if "await" in command_data:
                        for resource in command_data["await"]:
                            group, name = resource.split("/", 1)
                            await_resource(group, name)

                    if "sleep" in command_data:
                        sleep(command_data["sleep"])

def generate_readme(skewer_data):
    out = list()

    out.append(f"# {skewer_data['title']}")
    out.append("")
    out.append(skewer_data["subtitle"])

    # TOC

    out.append("")
    out.append("## Overview")
    out.append("")
    out.append(skewer_data["overview"])

    out.append("")
    out.append("## Prerequisites")
    out.append("")
    out.append(skewer_data["prerequisites"])

    for i, step_data in enumerate(skewer_data["steps"], 1):
        out.append("")
        out.append(f"## Step {i}: {step_data['title']}")

        if "preamble" in step_data:
            out.append("")
            out.append(step_data["preamble"])

        if "commands" in step_data:
            for session_name, session_data in step_data["commands"].items():
                pprint(session_data)

                out.append("")
                out.append(f"Console session `{session_name}`:")
                out.append("")
                out.append("```shell")

                for command_data in session_data:
                    pprint(command_data)
                    out.append(command_data["run"])

                out.append("```")

        if "postamble" in step_data:
            out.append("")
            out.append(skewer_data["postamble"])

    write("README.md", "\n".join(out))
